#!/usr/bin/env bash

exeuser=root
user=`whoami`
if [ $user != $exeuser ]; then
    echo "[Error] You need to run it on the '${exeuser}' user."
    exit
fi

LANG=en
NODE=${HOSTNAME}
REPOSITORY=""

if [ ! -f /var/chef/chef-host.conf ]; then
    echo "[Error] Not found /var/chef/chef-host.conf"
    exit
fi

. /var/chef/chef-host.conf

repodir=/var/chef/repo

if [ -z "$REPOSITORY" ]; then
    echo "[Error] You need to set repository url."
    exit
fi

# Initialize chef repository from git
if [ ! -e  $repodir/.git ]; then
    git clone $REPOSITORY $repodir
fi

# Update chef reopository using git pull.
cd $repodir
git pull

sudo /opt/chef/embedded/bin/berks --path cookbooks

nodefile="$repodir/nodes/${NODE}.json"
echo "sudo chef-solo -c ${repodir}/config/solo.rb -j ${nodefile}"
sudo chef-solo -c ${repodir}/config/solo.rb -j ${nodefile}







